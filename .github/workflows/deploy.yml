name: Deploy to VPS

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "========================================="
            echo "Deploying Kdongs Mono - Release: $RELEASE_TAG"
            echo "========================================="

            # Navigate to project directory
            cd $VPS_PATH

            # Pull latest changes
            echo "ðŸ“¥ Fetching latest code..."
            git fetch --all --tags

            # Checkout release tag or main branch
            if [ -n "$RELEASE_TAG" ]; then
              echo "Checking out release: $RELEASE_TAG"
              git checkout tags/$RELEASE_TAG
            else
              echo "Checking out main branch"
              git checkout main
              git pull origin main
            fi

            # Navigate to docker directory
            cd docker

            # Create backup before deployment
            echo "ðŸ’¾ Creating database backup..."
            ./postgres/scripts/export-database.sh ../backups "pre-deploy-$(date +%Y%m%d-%H%M%S)" || echo "âš ï¸  Backup skipped (database not running)"

            # Pull latest images and rebuild
            echo "ðŸ”¨ Building and deploying containers..."
            docker compose pull
            docker compose build --no-cache

            # Stop old containers
            echo "ðŸ›‘ Stopping old containers..."
            docker compose down

            # Start new containers
            echo "ðŸš€ Starting new containers..."
            docker compose up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 10

            # Check container status
            echo "ðŸ“Š Container Status:"
            docker compose ps

            # Show recent logs
            echo "ðŸ“‹ Recent logs:"
            docker compose logs --tail=50

            echo "========================================="
            echo "âœ… Deployment completed successfully!"
            echo "========================================="
          ENDSSH

      - name: Health Check
        env:
          VPS_DOMAIN: ${{ secrets.VPS_DOMAIN }}
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 5

          # Check if API is responding
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$VPS_DOMAIN/api/health || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  Health check returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Release: ${{ github.event.release.tag_name }}"
          echo "Deployed to: ${{ secrets.VPS_DOMAIN }}"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs and rollback if necessary."
