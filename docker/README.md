# Docker Production Configuration

This directory contains Docker configuration files for **production deployment** of the kdongs-mono application.

## Directory Structure

```
docker/
├── compose.yaml              # Production orchestration
├── nginx/                    # Nginx web server configuration
│   ├── nginx.conf           # Main nginx config
│   └── conf.d/
│       └── site.conf        # Site-specific configuration (SSL, routing)
├── postgres/                # PostgreSQL database configuration
│   ├── init/                # Database initialization scripts
│   │   └── init-setup.sh   # Creates extensions
│   └── scripts/             # Backup and restore scripts
│       ├── export-database.sh    # Database export/backup
│       ├── import-database.sh    # Database import/restore
│       └── auto-backup.sh        # Automated backup with retention
└── secrets/                 # Docker secrets (gitignored)
    ├── .gitkeep
    ├── root_pass            # Database password (generated by bootstrap)
    └── app_key              # AdonisJS APP_KEY (generated by bootstrap)
```

## Production Dockerfiles Location

**Production Dockerfiles are located in each package's docker directory:**

```
packages/backend/docker/
├── dockerfile.local         # Development
├── dockerfile.production    # Production ← Used by docker/compose.yaml
└── entrypoints/
    ├── local.sh            # Development entrypoint
    └── production.sh       # Production entrypoint ← Used by production dockerfile

packages/frontend/docker/
└── dockerfile.production    # Production ← Used by docker/compose.yaml
```

This structure keeps:
- **Production configs**: In `docker/` (orchestration) and `packages/*/docker/dockerfile.production`
- **Development configs**: In `packages/*/docker/` (dockerfile.local, compose.yaml)
- **Shared infrastructure**: In `docker/` (nginx, postgres, secrets)

## Services

### nginx
- **Purpose**: Web server and reverse proxy
- **Ports**: 80 (HTTP), 443 (HTTPS)
- **Features**:
  - Serves Angular frontend (SPA)
  - Proxies `/api/*` to backend
  - SSL/TLS termination with Let's Encrypt
  - HTTP to HTTPS redirect

### certbot
- **Purpose**: SSL certificate management
- **Features**:
  - Automatic certificate renewal every 12 hours
  - ACME challenge via webroot

### api-backend
- **Purpose**: AdonisJS API server
- **Build**: `packages/backend/docker/dockerfile.production`
- **Port**: 8000 (mapped to internal 3333)
- **Features**:
  - PostgreSQL connection
  - Access token authentication
  - RESTful API endpoints

### api-postgres
- **Purpose**: PostgreSQL database
- **Port**: 8001 (mapped to internal 5432)
- **Features**:
  - PostgreSQL 16 Alpine
  - Persistent data volume
  - Health checks
  - pg_stat_statements extension

### frontend-builder
- **Purpose**: Builds Angular application
- **Build**: `packages/frontend/docker/dockerfile.production`
- **Note**: This is a build-time service that exits after building

## Quick Start

### First Time Setup

1. Run the bootstrap script from the project root:
```bash
bash <(curl -fsSL https://raw.githubusercontent.com/lfsc09/kdongs-mono/main/scripts/vps-bootstrap.sh) your-domain.com your-email@example.com
```

2. Obtain SSL certificate:
```bash
cd /var/www/kdongs-mono/docker
docker compose up -d nginx
docker compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  -d your-domain.com -d www.your-domain.com \
  --email your-email@example.com \
  --agree-tos
```

3. Start all services:
```bash
docker compose up -d
```

### Daily Operations

```bash
# Start all services
docker compose up -d

# Stop all services
docker compose down

# View logs
docker compose logs -f

# View specific service logs
docker compose logs api-backend -f

# Check status
docker compose ps

# Restart a service
docker compose restart api-backend

# Rebuild and restart
docker compose up -d --build
```

## Configuration

### Environment Variables

Backend environment variables are set in `docker/compose.yaml`:
- `NODE_ENV=production`
- `DB_HOST=api-postgres`
- `DB_PORT=5432`
- `DB_USER=adonisjs`
- `DB_DATABASE=app`

Sensitive data comes from Docker secrets:
- `APP_KEY` - Loaded from `/run/secrets/app_key` in entrypoint
- `DB_PASSWORD` - Loaded from `/run/secrets/root_pass` in entrypoint

### Secrets

Docker secrets are stored in `docker/secrets/`:
- `root_pass` - Database password (generated by bootstrap)
- `app_key` - AdonisJS APP_KEY (generated by bootstrap)

**Security:**
- Never commit `docker/secrets/` to git (protected by .gitignore)
- Generated automatically by bootstrap script
- Mounted as read-only in containers at `/run/secrets/`

### Resource Limits

Resource limits are defined in `compose.yaml`:
- nginx: 0.25 CPU, 0.2GB RAM
- api-backend: 0.25 CPU, 0.4GB RAM
- api-postgres: 0.50 CPU, 1GB RAM

Adjust these based on your VPS capacity.

### Domain Configuration

Domain is configured in `nginx/conf.d/site.conf` and automatically updated by bootstrap script.

## Database Management

### Backups

Create manual backup:
```bash
./postgres/scripts/export-database.sh ../backups "backup-$(date +%Y%m%d)"
```

Automated backups are configured via cron (setup by bootstrap):
```bash
0 2 * * * /var/www/kdongs-mono/docker/postgres/scripts/auto-backup.sh 7
```

### Restore

```bash
./postgres/scripts/import-database.sh ../backups/backup-20241209-120000.sql.gz
```

### Access Database

```bash
docker exec -it kdongs-api-postgres psql -U adonisjs -d app
```

## Deployment

### Manual Deployment

```bash
cd /var/www/kdongs-mono
./scripts/deploy.sh [TAG]
```

### Automated Deployment

Deployments are triggered automatically on GitHub releases via GitHub Actions.

See [DEPLOYMENT.md](../DEPLOYMENT.md) for complete deployment guide.

## Troubleshooting

### Containers won't start
```bash
# Check logs
docker compose logs

# Check specific service
docker compose logs api-backend --tail=100

# Verify secrets exist
ls -la secrets/
```

### Database connection errors
```bash
# Check database is healthy
docker compose ps
docker exec kdongs-api-postgres pg_isready -U adonisjs

# Check backend environment
docker compose exec api-backend env | grep DB_
```

### SSL certificate issues
```bash
# Check certificate
docker compose exec nginx openssl x509 -in /etc/letsencrypt/live/your-domain.com/cert.pem -noout -dates

# Manual renewal
docker compose run --rm certbot renew --force-renewal
```

### Frontend not loading
```bash
# Check if files exist
docker compose exec nginx ls -la /usr/share/nginx/html/

# Rebuild frontend
docker compose up -d --build frontend-builder
```

## Volumes

Persistent data is stored in Docker volumes:
- `letsencrypt` - SSL certificates
- `certbot-www` - ACME challenge files
- `frontend-dist` - Built Angular application
- `api-postgres-data` - Database data

### Backup Volumes
```bash
# Backup database volume
docker run --rm -v kdongs_api-postgres-data:/data -v $(pwd):/backup alpine tar czf /backup/postgres-data-backup.tar.gz /data
```

### Restore Volumes
```bash
# Restore database volume
docker run --rm -v kdongs_api-postgres-data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/postgres-data-backup.tar.gz --strip 1"
```

## Security

1. **Secrets**: Never commit `secrets/` directory
2. **Ports**: Only 80 and 443 are exposed publicly (8000 and 8001 for internal access)
3. **Firewall**: Bootstrap script configures UFW to allow only necessary ports
4. **Updates**: Regularly update base images and rebuild

## Monitoring

### Container Stats
```bash
docker stats
```

### Health Checks
```bash
# API health
curl http://localhost:8000/health

# Database health
docker exec kdongs-api-postgres pg_isready -U adonisjs
```

### Logs
```bash
# All logs
docker compose logs -f

# Last 100 lines
docker compose logs --tail=100

# Specific service
docker compose logs api-backend -f
```

## See Also

- [DEPLOYMENT.md](../DEPLOYMENT.md) - Complete deployment guide
- [ARCHITECTURE.md](../ARCHITECTURE.md) - System architecture
- [Main README](../README.md) - Project overview
- [Backend Docker README](../packages/backend/docker/README.md) - Backend Docker development configs
